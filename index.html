<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥åœ‹éš›è²¡ç¶“é€Ÿè¦½</title>
    <style>
        :root {
            --primary-color: #5800cc; /* Yahoo ç´« */
            --secondary-color: #004fb6; /* é‰…äº¨ è— */
            --accent-color: #ff3333;
            --text-color: #333;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* é ‚éƒ¨å€åŸŸ */
        header {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border-left: 6px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-text h1 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
        }
        .header-text .date {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .source-indicator {
            font-size: 13px;
            background: #eee;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            vertical-align: middle;
            color: #666;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .source-dot {
            width: 8px;
            height: 8px;
            background-color: #ccc;
            border-radius: 50%;
        }
        .source-yahoo .source-dot { background-color: #5800cc; }
        .source-anue .source-dot { background-color: #004fb6; }
        .source-google .source-dot { background-color: #ea4335; }
        
        /* æ§åˆ¶æŒ‰éˆ•å€ */
        .controls {
            display: flex;
            gap: 10px;
        }
        button {
            cursor: pointer;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-refresh {
            background-color: #e2e8f0;
            color: #475569;
        }
        .btn-refresh:hover {
            background-color: #cbd5e1;
        }
        .btn-download {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-download:hover {
            background-color: #4600a3;
            box-shadow: 0 2px 8px rgba(88, 0, 204, 0.3);
        }

        /* æ–°èåˆ—è¡¨ */
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .news-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #eee;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            border-color: #e0e0e0;
        }
        .news-index {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 40px;
            font-weight: 900;
            color: #f1f1f1;
            line-height: 1;
            z-index: 0;
            pointer-events: none;
        }
        .card-content {
            position: relative;
            z-index: 1;
        }
        .news-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 10px 0;
            color: #1a202c;
            padding-right: 40px;
        }
        .news-title a {
            text-decoration: none;
            color: inherit;
        }
        .news-title a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .news-desc {
            font-size: 15px;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .news-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #888;
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
        }
        .source-tag {
            background: #f0fdf4;
            color: #166534;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        #status-msg {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        .error {
            color: var(--accent-color);
            background: #fff0f0;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffd0d0;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-text">
            <h1>ğŸŒ åœ‹éš›è²¡ç¶“å¿«å ±</h1>
            <div class="date">
                <span id="current-date">æ­£åœ¨è¼‰å…¥...</span>
                <span id="current-source-badge" class="source-indicator" style="display:none">
                    <span class="source-dot"></span> <span id="source-name"></span>
                </span>
            </div>
        </div>
        <div class="controls">
            <button class="btn-refresh" onclick="initFetch()">
                ğŸ”„ é‡æ–°æ•´ç†
            </button>
            <button class="btn-download" onclick="downloadReport()">
                ğŸ’¾ ä¸‹è¼‰ä»Šæ—¥å­˜æª”
            </button>
        </div>
    </header>

    <div id="news-container" class="news-list">
        <div id="status-msg">
            <div class="spinner"></div>
            æ­£åœ¨å»ºç«‹é€£ç·š...
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px; color: #aaa; font-size: 12px;">
        Generated by AI Assistant
    </div>
</div>

<script>
    // ä¾†æºè¨­å®š
    // æŠ€å·§ï¼šæˆ‘å€‘ä¸ç›´æ¥æŠ“ Yahooï¼Œè€Œæ˜¯é€é Google News å»æœå°‹ "site:tw.stock.yahoo.com åœ‹éš›"
    // é€™æ¨£å¯ä»¥ç¹é Yahoo çš„æ“‹ç‰†æ©Ÿåˆ¶ï¼Œä½†å–å¾—ä¸€æ¨¡ä¸€æ¨£çš„å…§å®¹
    const SOURCES = [
        {
            id: 'yahoo_via_google',
            name: "Yahoo è²¡ç¶“ (Googleé€šé“)",
            class: "source-yahoo",
            // Google News RSS æœå°‹æŒ‡ä»¤ï¼šsite:tw.stock.yahoo.com åŠ ä¸Š "åœ‹éš›" é—œéµå­—
            url: 'https://news.google.com/rss/search?q=site:tw.stock.yahoo.com/news/+%E5%9C%8B%E9%9A%9B&hl=zh-TW&gl=TW&ceid=TW:zh-TW'
        },
        {
            id: 'anue',
            name: "é‰…äº¨ç¶² (åœ‹éš›)",
            class: "source-anue",
            url: 'https://news.cnyes.com/rss/cat/int_news'
        },
        {
            id: 'google',
            name: "Google è²¡ç¶“",
            class: "source-google",
            url: 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWvfSkwyMHZNRGx6TVdZU0FqaGhtUHBSWWlnQVAB?hl=zh-TW&gl=TW&ceid=TW%3Azh-TW'
        }
    ];

    // ä»£ç†æœå‹™åˆ—è¡¨ (é‡å° Google News RSS é€™äº›é€šå¸¸å¾ˆç©©å®š)
    const PROXY_SERVICES = [
        (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&rand=${Math.random()}`,
        (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
    ];

    function updateDate() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('zh-TW', options);
    }

    async function initFetch() {
        updateDate();
        const container = document.getElementById('news-container');
        const badge = document.getElementById('current-source-badge');
        badge.style.display = 'none';
        
        container.innerHTML = `
            <div id="status-msg">
                <div class="spinner"></div>
                æ­£åœ¨å˜—è©¦é€£ç·š...
            </div>
        `;

        // ä¾åºå˜—è©¦æ‰€æœ‰ä¾†æº
        for (let source of SOURCES) {
            console.log(`æ­£åœ¨å˜—è©¦ä¾†æº: ${source.name}`);
            container.innerHTML = `
                <div id="status-msg">
                    <div class="spinner"></div>
                    æ­£åœ¨é€£ç·šè‡³ ${source.name}...
                </div>
            `;
            
            const items = await tryFetchSource(source.url, source.name);
            
            if (items && items.length > 0) {
                renderNews(items, source);
                return;
            }
        }

        // å…¨éƒ¨å¤±æ•—
        container.innerHTML = `
            <div id="status-msg" class="error">
                <h3>âš ï¸ ç„¡æ³•å–å¾—è³‡æ–™</h3>
                <p>æ‰€æœ‰ä¾†æºçš†ç„¡æ³•é€£ç·šã€‚</p>
                <button onclick="initFetch()" style="margin-top:15px; padding: 8px 20px;">å†è©¦ä¸€æ¬¡</button>
            </div>
        `;
    }

    async function tryFetchSource(rssUrl, sourceName) {
        for (let i = 0; i < PROXY_SERVICES.length; i++) {
            const proxyUrl = PROXY_SERVICES[i](rssUrl);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 6000); // 6ç§’

                const response = await fetch(proxyUrl, { 
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const str = await response.text();
                
                if (str.includes('<rss') || str.includes('<feed') || str.includes('<item')) {
                    const items = parseXML(str);
                    if (items.length > 0) return items;
                }
            } catch (err) {
                console.warn(`ä»£ç† ${i+1} å¤±æ•— (${sourceName})`);
            }
        }
        return null;
    }

    function parseXML(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            
            let items = Array.from(xmlDoc.querySelectorAll("item"));
            if (items.length === 0) items = Array.from(xmlDoc.querySelectorAll("entry"));

            return items.map(item => {
                const title = item.querySelector("title")?.textContent || "ç„¡æ¨™é¡Œ";
                let link = item.querySelector("link")?.textContent || "#";
                if (item.querySelector("link")?.getAttribute("href")) {
                    link = item.querySelector("link").getAttribute("href");
                }
                
                // å˜—è©¦æŠ“å–å„ç¨®å¯èƒ½çš„æè¿°æ¬„ä½
                let description = "";
                const descNode = item.querySelector("description");
                if (descNode) description = descNode.textContent;
                
                // Google News æœ‰æ™‚æœƒæŠŠå…§å®¹æ”¾åœ¨ content:encoded æˆ– summary
                if (!description || description.length < 10) {
                     description = item.querySelector("summary")?.textContent || "";
                }

                const pubDate = item.querySelector("pubDate")?.textContent || 
                                item.querySelector("published")?.textContent || "";
                
                return { title, link, description, pubDate };
            });
        } catch (e) {
            console.error("XML Parse Error", e);
            return [];
        }
    }

    function renderNews(items, source) {
        const container = document.getElementById('news-container');
        const badge = document.getElementById('current-source-badge');
        const sourceNameSpan = document.getElementById('source-name');
        
        badge.className = `source-indicator ${source.class}`;
        badge.style.display = 'inline-flex';
        sourceNameSpan.textContent = source.name;
        
        container.innerHTML = ''; 

        items.forEach((item, index) => {
            let cleanDesc = item.description.replace(/<[^>]*>?/gm, ''); 
            cleanDesc = cleanDesc.replace(/&nbsp;/g, ' '); 
            
            const txt = document.createElement("textarea");
            txt.innerHTML = cleanDesc;
            cleanDesc = txt.value;

            // æ¸…ç† Google News ä¾†æºæ¨™è¨˜
            cleanDesc = cleanDesc.replace(/Yahooå¥‡æ‘©è‚¡å¸‚.*/, '').replace(/é–±è®€å…¨æ–‡.*/, '');
            
            if (cleanDesc.length > 100) cleanDesc = cleanDesc.substring(0, 98) + '...';
            // å¦‚æœæè¿°å¤ªçŸ­ï¼Œçµ¦å€‹æç¤º
            if (cleanDesc.trim().length < 5) cleanDesc = "(é»æ“Šæ¨™é¡ŒæŸ¥çœ‹è©³ç´°å ±å°)";

            let dateStr = item.pubDate;
            try {
                const pubDate = new Date(item.pubDate);
                if (!isNaN(pubDate.getTime())) {
                    dateStr = pubDate.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                }
            } catch(e) {}

            const card = document.createElement('div');
            card.className = 'news-card';
            card.innerHTML = `
                <div class="news-index">${index + 1}</div>
                <div class="card-content">
                    <div class="news-title">
                        <a href="${item.link}" target="_blank">${item.title}</a>
                    </div>
                    <div class="news-desc">${cleanDesc}</div>
                    <div class="news-footer">
                        <span>ğŸ“… ${dateStr}</span>
                        <span class="source-tag">${source.name}</span>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function downloadReport() {
        const today = new Date().toISOString().split('T')[0];
        const fileName = `åœ‹éš›è²¡ç¶“å¿«å ±_${today}.html`;
        
        const styles = document.getElementsByTagName('style')[0].innerText;
        const newsContent = document.getElementById('news-container').innerHTML;
        const dateText = document.getElementById('current-date').textContent;
        const badgeHtml = document.getElementById('current-source-badge').outerHTML;

        const staticHtml = `
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹éš›è²¡ç¶“å¿«å ± - ${today}</title>
    <style>${styles}</style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-text">
                <h1>ğŸŒ åœ‹éš›è²¡ç¶“å¿«å ± (å­˜æª”)</h1>
                <div class="date">${dateText} ${badgeHtml}</div>
            </div>
            <div class="controls">
                <span style="font-size:12px; color:#888;">æ­¤ç‚ºéœæ…‹å­˜æª”</span>
            </div>
        </header>
        <div class="news-list">
            ${newsContent}
        </div>
        <div style="text-align: center; margin-top: 30px; color: #aaa; font-size: 12px;">
            Generated by AI Assistant
        </div>
    </div>
</body>
</html>`;

        const blob = new Blob([staticHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    window.onload = initFetch;
</script>

</body>
</html>